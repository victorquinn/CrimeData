<!DOCTYPE html>  <html> <head>   <title>fetchCrimes.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="fetchCrimes.html">                 fetchCrimes.js               </a>                                           <a class="source" href="index.html">                 index.js               </a>                                           <a class="source" href="app.html">                 app.js               </a>                                           <a class="source" href="crime.html">                 crime.js               </a>                                           <a class="source" href="index.html">                 index.js               </a>                                           <a class="source" href="CrimeData.html">                 CrimeData.js               </a>                                           <a class="source" href="CrimeDate.html">                 CrimeDate.js               </a>                                           <a class="source" href="CrimeList.html">                 CrimeList.js               </a>                                           <a class="source" href="CrimeMap.html">                 CrimeMap.js               </a>                                           <a class="source" href="CrimeWheel.html">                 CrimeWheel.js               </a>                                           <a class="source" href="CrimesHourly.html">                 CrimesHourly.js               </a>                                           <a class="source" href="DateDropdowns.html">                 DateDropdowns.js               </a>                                           <a class="source" href="api.html">                 api.js               </a>                                           <a class="source" href="home.html">                 home.js               </a>                                           <a class="source" href="index.html">                 index.js               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               fetchCrimes.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>API middleware to return a set of crimes given a year and month.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">config</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../config&#39;</span><span class="p">),</span>
    <span class="nx">request</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;request&#39;</span><span class="p">),</span>
    <span class="nx">moment</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;moment&#39;</span><span class="p">),</span>
    <span class="nx">_</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;underscore&#39;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>TODO: Tuck this under /config.js</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Configure redis. When run locally, uses local credentials, when run on
heroku or anywhere else with this environment variable set, will configure
for that environment.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">if</span> <span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">REDISTOGO_URL</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">rtg</span>   <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;url&quot;</span><span class="p">).</span><span class="nx">parse</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">REDISTOGO_URL</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">redis</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;redis&quot;</span><span class="p">).</span><span class="nx">createClient</span><span class="p">(</span><span class="nx">rtg</span><span class="p">.</span><span class="nx">port</span><span class="p">,</span> <span class="nx">rtg</span><span class="p">.</span><span class="nx">hostname</span><span class="p">);</span>
    <span class="nx">redis</span><span class="p">.</span><span class="nx">auth</span><span class="p">(</span><span class="nx">rtg</span><span class="p">.</span><span class="nx">auth</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]);</span> 
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">redis</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;redis&quot;</span><span class="p">).</span><span class="nx">createClient</span><span class="p">();</span> 
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Currently, this only takes year, month. Future enhancement for more granularity
Would love to have this pull by day, and then a helper function to request crimes
by month which actually does the request per day.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">year</span><span class="p">,</span> <span class="nx">month</span><span class="p">,</span> <span class="nx">day</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">start</span><span class="p">,</span> <span class="nx">end</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">day</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">month</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Retrieve a year's worth of data. CAUTION. This should be done by multiple API
calls, not one monster one as it is now.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">start</span> <span class="o">=</span> <span class="nx">moment</span><span class="p">(</span><span class="nx">year</span><span class="p">,</span> <span class="s1">&#39;YYYY&#39;</span><span class="p">);</span>
            <span class="nx">end</span> <span class="o">=</span> <span class="nx">moment</span><span class="p">(</span><span class="nx">year</span><span class="p">,</span> <span class="s1">&#39;YYYY&#39;</span><span class="p">).</span><span class="nx">add</span><span class="p">(</span><span class="s1">&#39;years&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="nx">start</span> <span class="o">=</span> <span class="nx">moment</span><span class="p">(</span><span class="nx">year</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="nx">month</span><span class="p">,</span> <span class="s1">&#39;YYYY-MM&#39;</span><span class="p">);</span>
            <span class="nx">end</span> <span class="o">=</span> <span class="nx">moment</span><span class="p">(</span><span class="nx">year</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="nx">month</span><span class="p">,</span> <span class="s1">&#39;YYYY-MM&#39;</span><span class="p">).</span><span class="nx">add</span><span class="p">(</span><span class="s1">&#39;months&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">start</span> <span class="o">=</span> <span class="nx">moment</span><span class="p">(</span><span class="nx">year</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="nx">month</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="nx">day</span><span class="p">,</span> <span class="s1">&#39;YYYY-MM-DD&#39;</span><span class="p">);</span>
        <span class="nx">end</span> <span class="o">=</span> <span class="nx">moment</span><span class="p">(</span><span class="nx">year</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="nx">month</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="nx">day</span><span class="p">,</span> <span class="s1">&#39;YYYY-MM-DD&#39;</span><span class="p">).</span><span class="nx">add</span><span class="p">(</span><span class="s1">&#39;days&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">redis_key</span> <span class="o">=</span> <span class="nx">start</span><span class="p">.</span><span class="nx">format</span><span class="p">()</span> <span class="o">+</span> <span class="nx">end</span><span class="p">.</span><span class="nx">format</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>redis.del(redis_key); // Temporary, uncomment to bust cache</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">redis</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">redis_key</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">body</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">error</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;error: &quot;</span> <span class="o">+</span> <span class="nx">error</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>If body is null, there was a cache miss, so let's hit the live API</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="nx">body</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">request</span><span class="p">(</span><span class="s2">&quot;http://sanfrancisco.crimespotting.org/crime-data?&amp;count=10000&amp;dtstart=&quot;</span> <span class="o">+</span> <span class="nx">start</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="s2">&quot;YYYY-MM-DDThh:mm:ss[Z]&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&amp;dtend=&quot;</span> <span class="o">+</span> <span class="nx">end</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="s2">&quot;YYYY-MM-DDThh:mm:ss[Z]&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&amp;format=json&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">body</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">error</span> <span class="o">&amp;&amp;</span> <span class="nx">response</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">===</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
                        <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">body</span><span class="p">);</span>

                        <span class="nx">redis</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">redis_key</span><span class="p">,</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">features</span><span class="p">),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">status</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Send the output back to the requester for handling</p>             </td>             <td class="code">               <div class="highlight"><pre>                            <span class="nx">next</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">features</span><span class="p">);</span>
                        <span class="p">});</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">});</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Since body wasn't null, this was a cache hit.
Send the output back to the requester for handling</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">next</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">body</span><span class="p">));</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>A sample entry from the source before we filter it:</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">sampleCrimeUnfiltered</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;44977&quot;</span><span class="p">,</span>
                              <span class="s2">&quot;type&quot;</span><span class="o">:</span><span class="s2">&quot;Feature&quot;</span><span class="p">,</span>
                              <span class="s2">&quot;geometry&quot;</span><span class="o">:</span>
                              <span class="p">{</span>
                                  <span class="s2">&quot;type&quot;</span><span class="o">:</span><span class="s2">&quot;Point&quot;</span><span class="p">,</span>
                                  <span class="s2">&quot;coordinates&quot;</span><span class="o">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">122.404232</span><span class="p">,</span><span class="mf">37.784496</span><span class="p">]</span>
                              <span class="p">},</span>
                              <span class="s2">&quot;properties&quot;</span><span class="o">:</span><span class="p">{</span>
                                  <span class="s2">&quot;crime_type&quot;</span><span class="o">:</span><span class="s2">&quot;SIMPLE ASSAULT&quot;</span><span class="p">,</span>
                                  <span class="s2">&quot;date_time&quot;</span><span class="o">:</span><span class="s2">&quot;2012-01-06 21:00:00&quot;</span><span class="p">,</span>
                                  <span class="s2">&quot;description&quot;</span><span class="o">:</span><span class="s2">&quot;BATTERY&quot;</span><span class="p">,</span>
                                  <span class="s2">&quot;case_number&quot;</span><span class="o">:</span><span class="s2">&quot;120023974&quot;</span><span class="p">,</span>
                                  <span class="s2">&quot;address&quot;</span><span class="o">:</span><span class="kc">null</span><span class="p">,</span>
                                  <span class="s2">&quot;zip_code&quot;</span><span class="o">:</span><span class="kc">null</span><span class="p">,</span>
                                  <span class="s2">&quot;beat&quot;</span><span class="o">:</span><span class="kc">null</span><span class="p">,</span>
                                  <span class="s2">&quot;accuracy&quot;</span><span class="o">:</span><span class="s2">&quot;9&quot;</span>
                              <span class="p">}</span>
                            <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>A sample entry after we've filtered it:</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">sampleCrimeFiltered</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="s2">&quot;44977&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;type&quot;</span><span class="o">:</span> <span class="s2">&quot;SIMPLE ASSAULT&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;description&quot;</span><span class="o">:</span> <span class="s2">&quot;BATTERY&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;case_number&quot;</span><span class="o">:</span> <span class="s2">&quot;120023974&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;date_time&quot;</span><span class="o">:</span> <span class="s2">&quot;2012-05-01 05:00:00&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;latitude&quot;</span><span class="o">:</span> <span class="o">-</span><span class="mf">122.403743</span><span class="p">,</span>
                            <span class="s2">&quot;longitude&quot;</span><span class="o">:</span> <span class="mf">37.775232</span>
                          <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>By removing redundant data we are not only paring down our dataset for
optimal transfer over the line, but also making it cleaner and easier
to use. No need to send along keys whose values are always null.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>We can go a step further though. With the above example, a month's data
clocks out at ~1.24MB. Still pretty large. Since a lot of these keys are
repeated, we can get a significant reduction in size just by shortening
some of those keys:</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">sampleCrimeFilteredSm</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="s2">&quot;44977&quot;</span><span class="p">,</span>
                              <span class="s2">&quot;t&quot;</span><span class="o">:</span> <span class="s2">&quot;SIMPLE ASSAULT&quot;</span><span class="p">,</span>
                              <span class="s2">&quot;d&quot;</span><span class="o">:</span> <span class="s2">&quot;BATTERY&quot;</span><span class="p">,</span>
                              <span class="s2">&quot;cn&quot;</span><span class="o">:</span> <span class="s2">&quot;120023974&quot;</span><span class="p">,</span>
                              <span class="s2">&quot;dt&quot;</span><span class="o">:</span> <span class="s2">&quot;2012-05-01 05:00:00&quot;</span><span class="p">,</span>
                              <span class="s2">&quot;lt&quot;</span><span class="o">:</span> <span class="o">-</span><span class="mf">122.403743</span><span class="p">,</span>
                              <span class="s2">&quot;lg&quot;</span><span class="o">:</span> <span class="mf">37.775232</span>
                            <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>This dropped the dataset down to ~1.02MB. Not a ton, but non-trivial.
However, adding GZip compression to requests dropped it down to only 118KB
so the previous gain is all but trivial. For now I restored the longer key
names since the GZip did so much, it could be left as a future enhancement
to go back to shortening them to remove redundancy though GZip mostly handles
that for us so it would not be super helpful and would be pretty confusing.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 